<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PathTracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 14px;
    }

    #panel button, #panel input[type="text"] {
      margin-top: 8px;
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 14px;
    }

    #info {
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <div id="info"><b>PathTracker</b><br>Press Start to begin tracking</div>
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <input type="text" id="filenameInput" placeholder="Enter filename" style="width: 160px;" />
    <button id="downloadBtn" disabled>Save Path</button>
    <input type="file" id="openFile" accept=".geojson" style="display:none" />
    <button id="openBtn">Load Path</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import GpsSmoother from 'https://cdn.jsdelivr.net/gh/WaltDub/GpsSmoother/GpsSmoother.js';

    const smoother = new GpsSmoother();
    const map = L.map('map').setView([57.0, 10.0], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let polyline = L.polyline([], { color: 'blue' }).addTo(map);
    let marker = null;
    let watchId = null;
    let totalDistance = 0;
    let minAltitude = null;
    let maxAltitude = null;
    let wakeLock = null;

    const info = document.getElementById('info');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const filenameInput = document.getElementById('filenameInput');
    const openBtn = document.getElementById('openBtn');
    const openFile = document.getElementById('openFile');

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);

    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('Wake Lock was released');
          });
          console.log('Wake Lock is active');
        } catch (err) {
          console.warn('Wake Lock failed:', err.name, err.message);
        }
      } else {
        showWakeLockWarning();
      }
    }

    function showWakeLockWarning() {
      const tip = isIOS
        ? 'Warning: On iOS, screen sleep may interrupt tracking. Consider disabling Auto-Lock in Settings.'
        : 'Warning: Wake Lock not supported. Tracking may pause if screen sleeps.';
      info.innerHTML += `<br><span style="color:red">${tip}</span>`;
    }

    function startTracking() {
      smoother.reset();
      totalDistance = 0;
      minAltitude = null;
      maxAltitude = null;
      polyline.setLatLngs([]);
      if (marker) marker.remove();
      marker = null;

      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude: lat, longitude: lon, altitude } = pos.coords;
        const last = smoother.positions.at(-1);
        smoother.addPosition(lat, lon, altitude);

        if (last) {
          const d = smoother._haversine({ lat, lon }, last);
          totalDistance += d;
        }

        if (altitude !== null && !isNaN(altitude)) {
          if (minAltitude === null || altitude < minAltitude) minAltitude = altitude;
          if (maxAltitude === null || altitude > maxAltitude) maxAltitude = altitude;
        }

        const data = smoother.getSmoothedData();
        info.innerHTML = `
          <b>PathTracker</b><br>
          Lat: ${lat.toFixed(5)}<br>
          Lon: ${lon.toFixed(5)}<br>
          Bearing: ${data.bearing?.toFixed(1)}°<br>
          Altitude: ${data.altitude?.toFixed(1)} m<br>
          Speed: ${data.speed?.toFixed(2)} m/s<br>
          Distance walked: ${(totalDistance / 1000).toFixed(2)} km<br>
          Min altitude: ${minAltitude?.toFixed(1) ?? '–'} m<br>
          Max altitude: ${maxAltitude?.toFixed(1) ?? '–'} m
        `;

        polyline.addLatLng([lat, lon]);
        if (!marker) {
          marker = L.marker([lat, lon]).addTo(map);
        } else {
          marker.setLatLng([lat, lon]);
        }
        map.panTo([lat, lon]);
      }, err => {
        info.innerText = 'GPS error: ' + err.message;
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      });

      startBtn.disabled = true;
      stopBtn.disabled = false;
      downloadBtn.disabled = true;

      requestWakeLock();
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }
      info.innerHTML += `<br><b>Tracking stopped.</b>`;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      downloadBtn.disabled = false;
    }

    function downloadGeoJSON() {
      const coords = smoother.positions.map(p => [p.lon, p.lat]);
      const geojson = {
        type: "FeatureCollection",
        features: [{
          type: "Feature",
          geometry: {
            type: "LineString",
            coordinates: coords
          },
          properties: {
            name: "PathTracker walk trace",
            distance_m: Math.round(totalDistance),
            min_altitude_m: minAltitude,
            max_altitude_m: maxAltitude
          }
        }]
      };

      let filename = filenameInput.value.trim();
      if (!filename) filename = "pathtracker";
      if (!filename.endsWith(".geojson")) filename += ".geojson";

      const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadGeoJSON(file) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const geojson = JSON.parse(e.target.result);
          const feature = geojson.features?.[0];
          if (feature?.geometry?.type === 'LineString') {
            const coords = feature.geometry.coordinates.map(([lon, lat]) => [lat, lon]);
            L.polyline(coords, { color: 'green' }).addTo(map);
            map.fitBounds(coords);
            info.innerHTML = `<b>PathTracker</b><br>Loaded saved trace with ${coords.length} points.`;
          } else {
            info.innerHTML = 'Invalid GeoJSON format.';
          }
        } catch (err) {
          info.innerHTML = 'Error loading file: ' + err.message;
        }
      };
      reader.readAsText(file);
    }

    openBtn.addEventListener('click', () => {
      openFile.click();
    });

    openFile.addEventListener('change
